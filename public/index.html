<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />

        <!-- CSS Libraries -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
        <link rel="stylesheet" href="/stylesheets/tasks.css">

        <!-- Javascript Libraries -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/vue@next"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>

    <body>
        <div id="application" class="d-flex" >
            <div class="ms-1 me-1 d-print-none">
                <!-- Displaying statistic -->
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Global Statistics</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>All tasks</td>
                            <td>{{ tasks.length }}</td>
                        </tr>
                        <tr>
                            <td>Done tasks</td>
                            <td>{{ tasks.filter(task => task.done).length }}</td>
                        </tr>
                        <tr>
                            <td>Filtered tasks</td>
                            <td>{{ filteredTasks.length }}</td>
                        </tr>
                        <tr v-if="getWorkingTimeForTodayHumanReadable(tasks) !== ''">
                            <td>Working Time for today</td>
                            <td>{{ getWorkingTimeForTodayHumanReadable(tasks) }}</td>
                        </tr>
                    </table>
                </table>
            </div>

            <div class="flex-grow-1 ms-1 me-1">
                <nav class="navbar fixed-top navbar-dark bg-dark d-print-none">
                    <div class="container-fluid">
                        <span class="navbar-brand mb-0 h1">Simple Tasks Manager</span>

                        <form class="d-flex">
                            <!-- Display working time button which allows to stop it and the duration -->
                            <button v-if="workingTimer.enabled" class="btn btn-danger text-nowrap" type="button" v-on:click="toggleWorkingTimer(workingTimer.taskId)">
                                <span class="bi-clock"></span>
                                Working timer enabled: {{ workingTimer.humanReadable }}
                            </button>

                            <!-- Options dropdown -->
                            <div class="dropdown text-white bg-dark">
                                <button class="btn dropdown-toggle text-white bg-dark" type="button" id="xdropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                Options
                                </button>
                                <ul class="dropdown-menu bg-dark" aria-labelledby="dropdownMenuButton1">
                                    <li>
                                        <button class="dropdown-item text-white" type="button" v-on:click="options.showDoneTasks = !options.showDoneTasks">
                                            <span v-bind:class="{'bi-square': !options.showDoneTasks, 'bi-check-square': options.showDoneTasks}"></span>
                                            Show done tasks
                                        </button>
                                    </li>
                                </ul>
                            </div>

                            <!-- Button to create a new task -->
                            <button class="btn btn-success ms-2 text-nowrap" type="button"
                                    data-bs-toggle="modal" data-bs-target="#new-task-dialog">
                                    Create Task</button>

                            <!-- Input for searching and filtering tasks -->
                            <input class="form-control ms-2"
                                type="search" placeholder="Search" aria-label="Search"
                                v-model="searchText">
                        </form>
                    </div>
                </nav>

                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Tasks</th>
                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr v-for="task in filteredTasks">
                            <td v-bind:class="{'text-decoration-line-through': task.done}">
                                <div class="fs-4">
                                        <span v-if="workingTimer.enabled && workingTimer.taskId === task.id"
                                    class="ms-1 bi-clock"
                                    ></span>
                                    {{ task.title }}
                                </div>
                                {{ task.description }}
                                <table v-if="task.subtasks && task.subtasks.length > 0" class="table table-sm table-striped">
                                    <thead class="table-dark small">
                                        <tr>
                                            <th>Subtasks</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(subtask, index) in task.subtasks">
                                            <td class="ps-3 small" v-bind:class="{'text-decoration-line-through': subtask.done}">
                                                {{ subtask.title }}
                                                <div class="d-flex small mt-2">
                                                    <attribute title="Created">{{ subtask.created }}</attribute>
                                                    <attribute title="Changed">{{ subtask.changed }}</attribute>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex float-end">
                                                    <span class="" v-bind:class="{'bi-square': !subtask.done, 'bi-check-square': subtask.done}"
                                                          v-bind:title="'Toggle done state for: ' + subtask.title"
                                                          v-on:click="toggleSubtaskDone(task, index)"></span>
                                                    <span class="ms-1 bi-pencil"
                                                          v-bind:title="'Edit subtask for: ' + subtask.title"
                                                          data-bs-toggle="modal" data-bs-target="#subtask-dialog"
                                                          v-on:click="editSubtaskUI(task, index)"></span>
                                                    <span class="ms-1 bi-trash"
                                                          v-bind:title="'Löschen der Subtask: ' + subtask.title"
                                                          data-bs-toggle="modal" data-bs-target="#delete-subtask-dialog"
                                                          v-on:click="deleteSubtaskUI(task, index)"></span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="d-flex mt-2">
                                    <span v-for="tag in task.tags">
                                        <tag v-on:click="searchText='tag:' + tag">{{ tag }}</tag>
                                    </span>
                                </div>
                                <div class="d-flex small mt-2">
                                    <attribute title="Created">{{ task.created }}</attribute>
                                    <attribute title="Changed">{{ task.changed }}</attribute>
                                    <attribute title="Priority">{{ model.priorityMap[task.priority] }}</attribute>
                                    <attribute title="Complexity">{{ model.complexityMap[task.complexity] }}</attribute>
                                    <attribute v-if="getWorkingTimeForTask(task) > 0" title="Working Time">{{ getWorkingTimeForTaskHumanReadable(task) }}</attribute>
                                    <attribute title="Done">{{ percentageDone(task) }}%</attribute>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex float-end">
                                    <span class="ms-1 bi-plus-circle"
                                          data-bs-toggle="modal" data-bs-target="#subtask-dialog"
                                          v-bind:title="'Adding subtask for: ' + task.title"
                                          v-on:click="addSubtaskUI(task)"></span>
                                    <span class="ms-1" v-bind:class="{'bi-square': !task.done, 'bi-check-square': task.done}"
                                          v-bind:title="'Toggle done state for: ' + task.title"
                                          v-on:click="toggleDone(task)"></span>
                                    <span v-if="!workingTimer.enabled"
                                          class="ms-1 bi-clock"
                                          v-bind:title="'Activate working timer for: ' + task.title"
                                          v-on:click="toggleWorkingTimer(task.id)"></span>
                                    <span class="ms-1 bi-pencil"
                                          v-bind:title="'Edit task for: ' + task.title"
                                          data-bs-toggle="modal" data-bs-target="#edit-task-dialog"
                                          v-on:click="editTaskUI(task)"></span>
                                    <span class="ms-1 bi-trash"
                                          v-bind:title="'Löschen der Task: ' + task.title"
                                          data-bs-toggle="modal" data-bs-target="#delete-task-dialog"
                                          v-on:click="deleteTaskUI(task.id)"></span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Dialog for defining a new task -->
                <div id="new-task-dialog" class="modal fade" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header text-white bg-dark">
                                <h5 class="modal-title">Create Task Dialog</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form>
                                    <div>
                                        <label class="form-label fw-bold">Title</label>
                                        <input class="form-control" type="text" placeholder="Title" v-model="model.newTask.title" autofocus>
                                    </div>
                                    <div class="mt-2">
                                        <label class="form-label fw-bold">Description</label>
                                        <input class="form-control" type="text" placeholder="Description"
                                            v-model="model.newTask.description">
                                    </div>

                                    <priority class="mt-2" v-model="model.newTask.priority"></priority>
                                    <complexity class="mt-2" v-model="model.newTask.complexity"></complexity>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary"
                                        data-bs-dismiss="modal" v-on:click="addTask()">Create Task</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dialog for editing a given task -->
                <div id="edit-task-dialog" class="modal fade" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header text-white bg-dark">
                                <h5 class="modal-title">Edit Task Dialog</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>

                            <div class="modal-body">
                                <ul class="nav nav-tabs">
                                    <li class="nav-item">
                                        <button class="nav-link active" type="button"
                                                data-bs-toggle="tab" data-bs-target="#edit-task-main">Main</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" type="button"
                                                data-bs-toggle="tab" data-bs-target="#edit-task-working-times">Working Times</button>
                                    </li>
                                </ul>

                                <div class="tab-content">
                                    <div class="tab-pane fade show active border-left border-bottom border-right p-2" id="edit-task-main">
                                        <form>
                                            <div>
                                                <label class="form-label fw-bold">Id</label>
                                                <input class="form-control" type="text" readonly placeholder="Title" v-model="editModel.task.id" autofocus>
                                            </div>
                                            <div class="mt-2">
                                                <label class="form-label fw-bold">Title</label>
                                                <input class="form-control" type="text" placeholder="Title" v-model="editModel.task.title" autofocus>
                                            </div>
                                            <div class="mt-2">
                                                <label class="form-label fw-bold">Description</label>
                                                <input class="form-control" type="text" placeholder="Description"
                                                    v-model="editModel.task.description">
                                            </div>

                                            <priority class="mt-2" v-model="editModel.task.priority"></priority>
                                            <complexity class="mt-2" v-model="editModel.task.complexity"></complexity>

                                            <div class="mt-2">
                                                <label class="form-label fw-bold">Working Time</label>
                                                <input class="form-control" type="text" placeholder="Working Time" v-model="editModel.workingTime">
                                            </div>

                                            <div class="mt-2">
                                                <label class="form-label fw-bold">Tag</label>
                                                <div class="d-flex flex-row">
                                                    <input class="form-control" type="text" placeholder="Description"
                                                           v-model="editModel.currentTag" list="all-tags">
                                                    <button type="button" class="btn btn-success text-nowrap ms-2"
                                                            v-on:click="addTag()">Add</button>
                                                    <datalist id="all-tags">
                                                        <option v-for="tag in getAllTags" v-bind:value="tag">
                                                    </datalist>
                                                </div>
                                                <div class="d-fley flex-row">
                                                    <span v-for="tag in editModel.task.tags">
                                                        <span class="badge bg-dark text-white ms-1">
                                                            {{ tag }}
                                                            <span class="bi-file-excel-fill ms-1" v-on:click="deleteTag(tag)"></span>
                                                        </span>
                                                    </span>
                                                </div>
                                            </div>
                                        </form>
                                    </div>

                                    <div class="tab-pane fade border-left border-bottom border-right p-2" id="edit-task-working-times">
                                        <table class="table table-striped">
                                            <thead class="table-dark">
                                                <th>Working Time</th>
                                                <th>Created</th>
                                                <th></th>
                                            </thead>
                                            <tbody>
                                                <tr v-for="entry in editModel.task.workingTimes">
                                                    <td>{{ workingTimeToHumanReadable(entry.workingTime) }}</td>
                                                    <td>{{ entry.created }}</td>
                                                    <td>
                                                        <span class="bi-trash"
                                                              v-on:click="deleteWorkingTime(entry)"></span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</span>
                                </button>
                                <button type="button" class="btn btn-primary"
                                        data-bs-dismiss="modal"
                                        v-on:click="updateTaskUI()">Update Task</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add subtask task dialog for asking user -->
            <div id="subtask-dialog" class="modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header text-white bg-dark">
                            <h5 v-if="editModel.subtask.index &gt;= 0" class="modal-title">Edit Subtask</h5>
                            <h5 v-if="editModel.subtask.index &lt; 0" class="modal-title">Add Subtask</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div>
                                    <label class="form-label fw-bold">Id</label>
                                    <input class="form-control" type="text" readonly placeholder="Id" v-model="editModel.task.id" autofocus>
                                </div>
                                <div class="mt-2">
                                    <label class="form-label fw-bold">Title</label>
                                    <input class="form-control" type="text" placeholder="Title" v-model="editModel.subtask.title" autofocus>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" v-on:click="updateTaskUI()">Update Task</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete task dialog for asking user -->
            <div id="delete-task-dialog" class="modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header text-white bg-dark">
                            <h5 class="modal-title">Delete Task</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Do you really want to delete '<span class="fw-bold">{{ deleteModel.task.title }}</span>'</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" v-on:click="deleteTask(deleteModel.task.id)">Yes</button>
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">No</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete subtask dialog for asking user -->
            <div id="delete-subtask-dialog" class="modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header text-white bg-dark">
                            <h5 class="modal-title">Delete Subtask</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Do you really want to delete '<span class="fw-bold">{{ deleteModel.subtask.title }}</span>'</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" v-on:click="deleteSubtask(deleteModel.task, deleteModel.subtask.index)">Yes</button>
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">No</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Mixin's -->
        <script src="/javascript/tasks/mixins/tasks.tools.mixin.js"></script>
        <script src="/javascript/tasks/mixins/tasks.crud.mixin.js"></script>
        <script src="/javascript/tasks/mixins/tasks.workingtime.mixin.js"></script>
        <script src="/javascript/tasks/mixins/tasks.edit.mixin.js"></script>

        <!-- Component's -->
        <script src="/javascript/tasks/components/tag.js"></script>
        <script src="/javascript/tasks/components/attribute.js"></script>
        <script src="/javascript/tasks/components/priority.js"></script>
        <script src="/javascript/tasks/components/complexity.js"></script>

        <!-- Application -->
        <script src="/javascript/tasks/application.js"></script>
    </body>
</html>
